import sys
import os
from PyQt5.QtWidgets import QApplication, QMainWindow, QLabel, QFileDialog
from PyQt5 import uic
import subprocess


class MemoryDumpWindow(QMainWindow):
    def __init__(self):
        super(MemoryDumpWindow, self).__init__()
        uic.loadUi('ramcapture.ui', self)
        self.show()

        # Connect the mousePressEvent of the labels to their respective slots
        self.pathofwinpmem.mousePressEvent = self.select_path_of_winpmem
        self.destinationpath.mousePressEvent = self.select_destination_path

        # Set initial note for the label
        self.notelabel.setText("Select path")

        # Connect the capturememory button click event to the function
        self.capturememory.clicked.connect(self.execute_memory_capture)

        # Initialize path1 and path2 variables
        self.path1 = ""
        self.path2 = ""

    def select_path_of_winpmem(self, event):
        if event.button() == 1:  # Left mouse button
            path, _ = QFileDialog.getOpenFileName(self, 'Select Path of Winpmem')
            if path:
                self.pathofwinpmem.setText(path)  # Update the QLineEdit with the selected path
                self.path1 = path

    def select_destination_path(self, event):
        if event.button() == 1:  # Left mouse button
            path = QFileDialog.getExistingDirectory(self, 'Select Destination Path')
            if path:
                self.destinationpath.setText(path)  # Update the QLineEdit with the selected destination path
                self.path2 = path

    def execute_memory_capture(self):
        if self.path1 and self.path2:
            self.notelabel.setText("Please wait...")
            QApplication.processEvents()  # Allow GUI to update and display "Please wait..."
            try:
                subprocess.run([self.path1, self.path2 + "/memorydump.vmem"])
                self.notelabel.setText("Memory captured successfully")
            except Exception as e:
                self.notelabel.setText(f"Error: {str(e)}")
        else:
            self.notelabel.setText("Select path")


if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = MemoryDumpWindow()
    sys.exit(app.exec_())
